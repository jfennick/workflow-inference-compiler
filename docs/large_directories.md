# Large Directory Performance in CWL

First off, what is a Directory object in CWL?

According to [the documentation](https://www.commonwl.org/v1.2/CommandLineTool.html#Directory), a Directory object is an in-memory JSON metadata blob. When used as an inputBinding: in a CommandLineTool, File and Directory objects are simply serialized as strings.

There are also various nuances w.r.t. ["staging" input files](https://www.commonwl.org/user_guide/topics/staging-input-files.html) with InitialWorkDirRequirement and more dangerously using [InplaceUpdateRequirement](https://www.commonwl.org/v1.2/CommandLineTool.html#InplaceUpdateRequirement).

## Example workflow
The simplest possible example workflow takes a large Directory object as input, but does not actually use it.
```
steps:
  ls:
    in:
      directory: !ii ../../mm-workflows/examples/scripts/refined-set
```

## Cachedir uses symlinks
The first thing to note is that by default --cachedir does NOT copy; it uses symlinks.

```
  InitialWorkDirRequirement:
    listing:
    - $(inputs.directory)
```

```
$ ls -al cachedir/20bebee1ff10fe59bb8aad4a467e9361/
total 40
drwxr-xr-x 2 jfennick jfennick  4096 May 23 09:42 .
drwxr-xr-x 3 jfennick jfennick  4096 May 23 09:42 ..
lrwxrwxrwx 1 jfennick jfennick    62 May 23 09:42 refined-set -> .../mm-workflows/examples/scripts/refined-set
-rw-r--r-- 1 jfennick jfennick 26593 May 23 09:42 stdout
```

Notice that the input directory is symlinked as a subdirectory within the working directory; the input directory contents are not symlinked directly into the temporary working directory. (Otherwise, if you stage two directories that each contain common filenames, there could be filename collisions!)

In other words, your CommandLineTool will need to refer to subdir1/filename.ext and/or subdir2/filename.ext instead of just filename.ext

## Directories and deep_listing performance

```
cwlVersion: v1.0
```

If you want to use v1.0 (see below), the following warning will be clearly printed to stdout:

```
$ wic --yaml examples/large_directory.wic --generate_run_script
$ time ./run.sh
...
WARNING autogenerated/large_directory__step__1__ls/ls.cwl:15:3: Recursive directory listing has
                                                                    resulted in a large number of
                                                                    File objects (21277) passed to
                                                                    the input parameter
                                                                    'directory'.  This may
                                                                    negatively affect workflow
                                                                    performance and memory use.

                                                                    If this is a problem, use the
                                                                    hint
                                                                    'cwltool:LoadListingRequirement'
                                                                    with "shallow_listing" or
                                                                    "no_listing" to change the
                                                                    directory listing behavior:

                                                                    $namespaces:
                                                                      cwltool:
                                                                      "http://commonwl.org/cwltool#"
                                                                    hints:

                                                                      cwltool:LoadListingRequirement:
                                                                        loadListing: shallow_listing
...
INFO [workflow ] completed success
INFO Final process status is success

real    0m17.075s
user    0m11.845s
sys     0m2.007s
```

There are two solutions: You can change the listing behavior (again, as per the above warning)

```
hints:
  cwltool:LoadListingRequirement:
    loadListing:
      no_listing:
```

or you can use cwlVersion v1.1 or above. See the [v1.1 changelog](https://www.commonwl.org/v1.1/CommandLineTool.html#Changelog).

## Staging directory contents

If you want to eliminate the subdirectory and directly stage the input directory contents, use this javascript:

```
    listing: |
      ${
        var lst = [];
        for (var i = 0; i < inputs.directory.listing.length; i++) {
          lst.push(inputs.directory.listing[i]);
        }
        return lst;
      }
```

Again, this will use symlinks instead of copying.

Note that the .listing method requires cwlVersion: v1.0

## writable: copies!

On the other hand, if you use the writable: tag

```
    listing: |
      ${
        var lst = [];
        for (var i = 0; i < inputs.directory.listing.length; i++) {
          var dict = {
            "entry": inputs.directory.listing[i],
            "writable": true // Causes copying!
          };
          lst.push(dict);
        }
        return lst;
      }
```

The entries will all be copied into cachedir instead of symlinked.  The [writable: documentation](https://www.commonwl.org/v1.1/CommandLineTool.html#Dirent) says: "If true, the file or directory must be writable by the tool. Changes to the file or directory must be isolated and not visible by any other CommandLineTool process. **This may be implemented by making a copy of the original file or directory.**"

## Multistep workflows still use symlinks

It is worth explicitly noting that passing Directory objects between steps within a workflow still uses symlinks and does not cause copying:

```
steps:
  identity:
    in:
      input: !ii ../../mm-workflows/examples/scripts/refined-set
    out:
    - output: !& directory
  ls:
    in:
      directory: !* directory
```

## Directories and --provenance performance

Unfortunately, the --provenance feature appears to (currently) have a very large performance penalty.

(Performance improvements are in progress; see https://github.com/trungdong/prov/pull/158)

```
$ wic --yaml examples/large_directory.wic --generate_run_script
$ time ./run.sh
...
INFO [workflow ] completed success
INFO Final process status is success
INFO [provenance] Finalizing Research Object
INFO [provenance] Research Object saved to .../provenance/large_directory

real    3m29.251s
user    3m18.998s
sys     0m8.434s
```

As you can see, the --provenance flag spends significant amount of time copying all of the files from the input directory (and more importantly calculating checksums, metadata, etc):

```
$ ls provenance/large_directory/data/ | wc -l
256
$ find provenance/large_directory/data/ -name '[0-9a-z][0-9a-z]' | xargs ls | wc -l
21788
$ ls provenance/large_directory/metadata/ | wc -l
10641
```

This is true even if the files aren't even used:

```
$ cat provenance/large_directory/workflow/primary-job.json
{
    "large_directory__step__1__ls___directory": {
        "class": "Directory",
        "basename": "refined-set"
    },
    "large_directory__step__1__ls___filenames": []
}
$ ls cachedir/
5511d7c8003e048ab683de80ac635c0b  5511d7c8003e048ab683de80ac635c0b.status
$ ls cachedir/5511d7c8003e048ab683de80ac635c0b | wc -l
0
```

It is unclear if symlinking is a good idea here, since the purpose of provenance is to improve reproducibility by retaining copies of all inputs, metadata, etc required to execute a workflow.

That said, if you absolutely must, you can temporarily disable provenance using the --no_provenance flag.

```
$ wic --yaml examples/large_directory.wic --generate_run_script --no_provenance
$ time ./run.sh
...
INFO [workflow ] completed success
INFO Final process status is success

real    0m2.058s
user    0m1.123s
sys     0m0.073s
```